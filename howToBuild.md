# tiledbcloud

Work in progress

## How this was built

* Initially using then-current (2020-Aug-07) Docker container `openapitools/openapi-generator-cli:latest`
* Now via the offical v5.0.0 release `openapitools/openapi-generator-cli:v5.0.0`
* Standard invocation using TileDB Cloud API Spec v1, setting package name and version
* Some manual edits (detailed below)
* Invoking `roxygen2::roxygenise()` to build interactive R documentation followed by a one-word fix to one Rd file
* Invoking `pkgdown:build_site()` to build HTML documentation

## Prep

Prep: the Docker command in `runMe.sh` will read its current directory and write
the following into `./tiledbcloud-generated`: `DESCRIPTION`, `NAMESPACE`,
`README.md`, `R`, `docs`, `man`, `tests`, and `git_push.sh`. Unfortunately it will read the _current_ files
from the working directory as well.

In either case we need a current `openapi-v1.yaml` copied from [https://github.com/TileDB-Inc/TileDB-Cloud-API-Spec](https://github.com/TileDB-Inc/TileDB-Cloud-API-Spec) into `.`.

### Autogen option 1

```
mkdir /tmp/gen
cp openapi-v1.yaml   /tmp/gen
cp runMe.sh          /tmp/gen
cp regenerate-docs.r /tmp/gen/
cp -a .openapi-generator* /tmp/gen

cd /tmp/gen
./runMe.sh
```

Then remove `DESCRIPTION`, `NAMESPACE`, `R`, `docs`, `man`, `test` from this
repo directory (maybe `mkdir old` and `mv` them to `old`) with outputs from
`/tmp/gen`. Then move `/tmp/gen/README.md` to `./origREADME.md`.

### Autogen option 2

```
mkdir old
mv DESCRIPTION old
mv NAMESPACE   old
mv README.md   old
mv R           old
mv docs        old
mv man         old
mv tests       old
mv git_push.sh old

./runMe.sh
```

Then move `./README.md` to `./origREADME.md` and `old/README.md` to `.`.

### Post-processing

In either case, be sure any manual-layer files (such as `init.R` -- listed in
`runMe.sh`) are copied back to `./R`. Then remove `NAMESPACE` and (in R)
`library(devtools)` and `devtools::document()`. (The `NAMESPACE` file must be
removed first since it was generated by `openapi-generator` so `devtools` will
skip it.) This will ensure that exported functions in the manual-layer files
are properly exported.

*Important* The generated API wants to also parse a field `User` which we
apparently do not send. So the default deserializer breaks. See PR #2 and its
small diff to `R/api_client.R` file for a fix that needs to be re-applied.

Also `diff -r old/R R` and see what other manual edits need to be re-applied.
In particular, all manual edits needing re-application should be marked with
`MANUAL EDIT AFTER OPENAPI AUTOGEN`.

Also manually edit `DESCRIPTION`, carrying over manual edits from before the
autogen run.

Also:

```
R CMD build .
R CMD INSTALL .
```

Then in R:

```
library(roxygen2); roxygenise()
library(pkgdown); build_site()
```

The latter should pop open a browser preview of the autogenerated API docs. You
can `git add` and commit the `www` directory.

Note that you need to re-run `build_site` after editing any `*.md` files in
this repo, as it generates HTML from markdown files. Check all the HTML for any
markdown-formatting issues.

## Build and Test

```sh
R CMD build .                           # creates eg tiledbcloud_0.0.3.tar.gz
R CMD check tiledbcloud_0.0.3.tar.gz    # checks the package

## Demo

A few first commands (see [local/](local/) as well)

```r
library(tiledbcloud)

cl <- ApiClient$new(basePath="https://api.tiledb.com/v1",
                    accessToken=Sys.getenv("TILEDB_REST_TOKEN"),
                    username=Sys.getenv("TILEDB_REST_USENAME"),
                    password=Sys.getenv("TILEDB_REST_PASSWORD"))

api <- UserApi$new(cl)
# still needs this
api$apiClient$apiKeys['X-TILEDB-REST-API-KEY'] <- Sys.getenv("TILEDB_REST_TOKEN")
## alternative if no 'ApiClient' instance
##api$apiClient$username <- Sys.getenv("TILEDB_REST_USENAME")
##api$apiClient$password <- Sys.getenv("TILEDB_REST_PASSWORD")
##api$apiClient$basePath <- "https://api.tiledb.com/v1"
api$GetSession()

## Array Example

arr <- ArrayApi$new(cl)
arr$GetArrayMetadata("TileDB-Inc", "quickstart_dense")

## SQL Example

sql <- SqlApi$new(cl)
sqlpar <-  SQLParameters$new(name="SomethingToFillInHere",
                             query="select `rows`, AVG(a) as avg_a from `tiledb://TileDB-Inc/quickstart_dense` GROUP BY `rows`")
ans <- sql$RunSQL("TileDB-Inc", sqlpar)

data.table::rbindlist( ans )            # easiest helper to glue rows together
```
